{{ $script := .Site.Data.webpack_assets.app }}
{{ with $script.js }}
  <script src="{{ relURL (printf "%s%s" "dist/" .) }}"></script>
{{ end }}
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.1/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.1/languages/pony.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.5/lunr.min.js"></script>

<script async defer src="https://buttons.github.io/buttons.js"></script>

<script>
  var toggleBtns = document.getElementsByClassName('js-toggle')
  for (var i = 0; i < toggleBtns.length; i++) {
    toggleBtns[i].addEventListener('click', toggleClass, false)
  }

  var myToggleBtns = document.getElementsByClassName('hide-show-toggle')
  for (var i = 0; i < myToggleBtns.length; i++) {
    myToggleBtns[i].addEventListener('click', hideShow, false)
  }

function hideShowDM() {
  var menu = document.getElementById("doc-menu")
  var thebody = document.getElementById("the-body")
  if (window.getComputedStyle(menu).display == "none") {
    menu.style.display = "block";
    thebody.style.left = "300px";
  } else {
    menu.style.display = "none";
    thebody.style.left = "0px";
  }
}

function hideShowCM() {
  var menu = document.getElementById("context-menu")
  if (window.getComputedStyle(menu).display == "none") {
    menu.style.display = "block";
  } else {
    menu.style.display = "none";
  }
}

function toggleClass() {
  // Define the data target via the dataset "target" (e.g. data-target=".docsmenu")
  var content = this.dataset.target.split(' ')
  // Find any menu items that are open
  var mobileCurrentlyOpen = document.querySelector('.mobilemenu:not(.dn)')
  var desktopCurrentlyOpen = document.querySelector('.desktopmenu:not(.dn)')
  var desktopActive = document.querySelector('.desktopmenu:not(.dn)')

  // Loop through the targets' divs
  for (var i = 0; i < content.length; i++) {
    var matches = document.querySelectorAll(content[i]);
    //for each, if the div has the 'dn' class (which is "display:none;"), remove it, otherwise, add that class
    [].forEach.call(matches, function(dom) {
        dom.classList.contains('dn') ?
        dom.classList.remove('dn') :
        dom.classList.add('dn');
         return false;
       });
        // close the currently open menu items
      if (mobileCurrentlyOpen) mobileCurrentlyOpen.classList.add('dn')
      if (desktopCurrentlyOpen) desktopCurrentlyOpen.classList.add('dn')
      if (desktopActive) desktopActive.classList.remove('db')

    }
  }


var ponySearch = undefined;

function doSearch(query) {
    var resultsContainer = $('#search-results');
    var contentContainer = $('#content');
    var results = ponySearch.lunrIndex.search(query).map(function(result) {
         console.log(result);
         return ponySearch.pages.find(function(page) {
           return page.uri === result.ref;
         });
    });
    resultsContainer.empty();
    var resList = $("<ul>", /*{class: "TODO"}*/);
    results.slice(0, 100).forEach(function(result) {
       var res = $("<li>");
         res.append($("<a>", {
           href: result.uri,
           text: result.title
         }));
         resList.append(res);
    });
    resultsContainer.append(resList);
    contentContainer.addClass("dn");
    resultsContainer.removeClass("dn");
}

function initLunr(onSuccess) {
  $.getJSON("/index.json")
    .done(function(index) {
       console.log("downloaded search-index");
       ponySearch = {};
       ponySearch.pages = index;
       ponySearch.lunrIndex = lunr(function() {
         this.field("title", { boost: 10 });
         this.field("tags", { boost: 5 });
         this.field("categories", { boost: 5 });
         this.field("content");
         this.ref("uri");

         index.forEach(function (page) {
             this.add(page)
           },
           this
         );
       });
       onSuccess();
    })
    .fail(function(jqxhr, textStatus, error) {
      var err = textStatus + ", " + error;
      console.error("Error getting search index flie:", err);
    });
}

function setUpSearchUI() {
    $('#search-box').keyup(function() {
        var query = $(this).val();
        if (query.length < 2) {
            if (query.length == 0) {
                $('#content').removeClass('dn');
                $('#search-results').empty().addClass('dn');
            }
            return;
        }
        if (ponySearch === undefined) {
            initLunr(function () {
              doSearch(query);
            });
        } else {
            doSearch(query);
        }
    });
    console.log("search set up");
}
$(document).ready(function() {
  setUpSearchUI();
});
</script>
